
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Daniel Joven" name="author"/>
<link href="https://zentyal-aws.projects.djoven.es/en/zentyal-hardening/" rel="canonical"/>
<link href="../zentyal-certificates/" rel="prev"/>
<link href="../backup/" rel="next"/>
<link href="../../assets/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.6" name="generator"/>
<title>Hardening - Zentyal &amp; AWS</title>
<link href="../../assets/stylesheets/main.ded33207.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="red" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#hardening">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Zentyal &amp; AWS" class="md-header__button md-logo" data-md-component="logo" href="../" title="Zentyal &amp; AWS">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Zentyal &amp; AWS
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Hardening
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg>
</label>
</form>
<div class="md-header__option">
<div class="md-select">
<button aria-label="Select language" class="md-header__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"></path></svg>
</button>
<div class="md-select__inner">
<ul class="md-select__list">
<li class="md-select__item">
<a class="md-select__link" href="../../zentyal-hardening/" hreflang="es">
                    Spanish
                  </a>
</li>
<li class="md-select__item">
<a class="md-select__link" href="./" hreflang="en">
                    English
                  </a>
</li>
</ul>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/djoven89/zentyal-aws" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../aws-configuration/">
      AWS
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../zentyal-installation/">
      Install
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../zentyal-configuration/">
      Configuration
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../zentyal-certificates/">
      Certificates
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="./">
      Hardening
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../backup/">
      Backup
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../monitoring/">
      Monitoring
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../maintenance/">
      Maintenance
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../recovery/">
      Recovery
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../zentyal-bug-fixing/">
      Bug fixing
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../about/">
      About me
    </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Zentyal &amp; AWS" class="md-nav__button md-logo" data-md-component="logo" href="../" title="Zentyal &amp; AWS">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Zentyal &amp; AWS
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/djoven89/zentyal-aws" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
        Home
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../aws-configuration/">
        AWS
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zentyal-installation/">
        Install
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zentyal-configuration/">
        Configuration
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zentyal-certificates/">
        Certificates
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Hardening
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Hardening
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#domain-controller-module">
    Domain Controller module
  </a>
<nav aria-label="Domain Controller module" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#password-policy">
    Password policy
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mail-module">
    Mail module
  </a>
<nav aria-label="Mail module" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#spf">
    SPF
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dkim">
    DKIM
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dmarc">
    DMARC
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#webmail-module">
    Webmail module
  </a>
<nav aria-label="Webmail module" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#apache">
    Apache
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../backup/">
        Backup
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monitoring/">
        Monitoring
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../maintenance/">
        Maintenance
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../recovery/">
        Recovery
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../zentyal-bug-fixing/">
        Bug fixing
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../about/">
        About me
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<nav class="md-tags">
<span class="md-tag">Zentyal</span>
</nav>
<h1 id="hardening">Hardening<a class="headerlink" href="#hardening" title="Permanent link">¶</a></h1>
<p>On this page, a series of implementations will be carried out in several modules whose purpose is to increase their security.</p>
<p>The modules on which these improvements will be applied are:</p>
<ul>
<li>Domain controller</li>
<li>Mail</li>
<li>Webmail</li>
</ul>
<h2 id="domain-controller-module">Domain Controller module<a class="headerlink" href="#domain-controller-module" title="Permanent link">¶</a></h2>
<p>The additional security configurations that will be implemented in the domain controller module are:</p>
<ul>
<li>Password policies.</li>
</ul>
<h3 id="password-policy">Password policy<a class="headerlink" href="#password-policy" title="Permanent link">¶</a></h3>
<p>We will establish password policies through the <code>samba-tool domain passwordsettings</code> command for domain users, in this way, we will reduce the possibility of weak passwords being used.</p>
<p>Additionally, it should be mentioned that starting from Samba 4.9, it is possible to define more particular password policies as explained in <a href="https://wiki.samba.org/index.php/Password_Settings_Objects">this</a> link. However, using this functionality has a resource increase as mentioned in the link, so I will not use this specific functionality in my particular case.</p>
<p>The policies that I will define are:</p>
<ul>
<li>I will enable password complexity.</li>
<li>I will set a minimum of 8 characters that passwords must have.</li>
<li>A password will have a maximum validity period of 6 months.</li>
</ul>
<p>The following are the actions to be performed to apply these policies:</p>
<ol>
<li>
<p>We verify the default policies in use:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo<span class="w"> </span>samba-tool<span class="w"> </span>domain<span class="w"> </span>passwordsettings<span class="w"> </span>show
</code></pre></div></td></tr></table></div>
<p>The result obtained in my case is:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>Password information for domain 'DC=icecrown,DC=es'
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>Password complexity: off
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>Store plaintext passwords: off
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>Password history length: 24
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>Minimum password length: 0
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>Minimum password age (days): 0
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>Maximum password age (days): 365
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>Account lockout duration (mins): 30
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>Account lockout threshold (attempts): 0
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>Reset account lockout after (mins): 30
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We establish the new policies:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>sudo<span class="w"> </span>samba-tool<span class="w"> </span>domain<span class="w"> </span>passwordsettings<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span>--complexity<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span>--min-pwd-length<span class="o">=</span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span>--max-pwd-age<span class="o">=</span><span class="m">180</span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We show the configuration again to make sure that the policies were applied:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>sudo<span class="w"> </span>samba-tool<span class="w"> </span>domain<span class="w"> </span>passwordsettings<span class="w"> </span>show
</code></pre></div></td></tr></table></div>
<p>The result obtained in my case is:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>Password information for domain 'DC=icecrown,DC=es'
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>Password complexity: on
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>Store plaintext passwords: off
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>Password history length: 24
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>Minimum password length: 8
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>Minimum password age (days): 0
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>Maximum password age (days): 180
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>Account lockout duration (mins): 30
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>Account lockout threshold (attempts): 0
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>Reset account lockout after (mins): 30
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Finally, we try to create a user with a weak password to confirm that the policies are in operation:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/hardening-dc_password.png"><img alt="User with weak password" src="../assets/zentyal/hardening-dc_password.png" title="User with weak password"/></a></p>
</li>
</ol>
<h2 id="mail-module">Mail module<a class="headerlink" href="#mail-module" title="Permanent link">¶</a></h2>
<p>For this module, we will implement the following features to significantly increase the security of our mail service:</p>
<ul>
<li>SPF</li>
<li>DKIM</li>
<li>DMARC</li>
</ul>
<h3 id="spf">SPF<a class="headerlink" href="#spf" title="Permanent link">¶</a></h3>
<p><a href="https://support.google.com/a/answer/33786?hl=en-419">SPF</a> will be the first one we will implement. The goal that SPF tries to cover is to protect our domain against spoofing and phishing attacks. Basically, we will create a record in our DNS which will indicate which servers can send emails from our domain. For more information, see <a href="https://www.mimecast.com/content/sender-policy-framework/">this</a> link.</p>
<ol>
<li>
<p>Through <a href="https://www.spfwizard.net/">this</a> website, we will generate the necessary DNS record to implement this authentication method:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-spf.png"><img alt="SPF generator" src="../assets/zentyal/mail-spf.png" title="SPF generator"/></a></p>
</li>
<li>
<p>We create the <code>TXT</code> record both in the DNS module and in the DNS provider - in my case, Route53 -:</p>
<p>For Zentyal, we go to <code>DNS -&gt; Domains -&gt; TXT records</code>:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-spf_zentyal.png"><img alt="SPF Zentyal record" src="../assets/zentyal/mail-spf_zentyal.png" title="SPF Zentyal record"/></a></p>
<p>For Route 53:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-spf_route53.png"><img alt="SPF Route53 record" src="../assets/zentyal/mail-spf_route53.png" title="SPF Route53 record"/></a></p>
</li>
<li>
<p>We check the resolution of the new record both internally and externally:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>dig<span class="w"> </span>TXT<span class="w"> </span>icecrown.es
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>dig<span class="w"> </span>@8.8.8.8<span class="w"> </span>icecrown.es
</code></pre></div></td></tr></table></div>
<p>The result obtained in my case:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>## Internal query (from Zentyal)
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; TXT icecrown.es
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>;; global options: +cmd
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>;; Got answer:
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 8888
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>; EDNS: version: 0, flags:; udp: 4096
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>; COOKIE: f1292e180a5d3b430100000063f25f4ddf828c60e1a71af2 (good)
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>;; QUESTION SECTION:
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>;icecrown.es.           IN  TXT
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>;; ANSWER SECTION:
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>icecrown.es.        259200  IN  TXT "v=spf1 mx ip4:15.237.168.75 ~all"
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>;; Query time: 204 msec
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>;; SERVER: 127.0.0.1#53(127.0.0.1)
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>;; WHEN: Sun Feb 19 18:41:33 CET 2023
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>;; MSG SIZE  rcvd: 113
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>## External query
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; @8.8.8.8 TXT icecrown.es
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>; (1 server found)
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>;; global options: +cmd
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>;; Got answer:
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 5656
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>; EDNS: version: 0, flags:; udp: 512
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>;; QUESTION SECTION:
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>;icecrown.es.           IN  TXT
<a id="__codelineno-6-35" name="__codelineno-6-35"></a>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>;; ANSWER SECTION:
<a id="__codelineno-6-37" name="__codelineno-6-37"></a>icecrown.es.        300 IN  TXT "v=spf1 mx ip4:15.237.168.75 ~all"
<a id="__codelineno-6-38" name="__codelineno-6-38"></a>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a>;; Query time: 16 msec
<a id="__codelineno-6-40" name="__codelineno-6-40"></a>;; SERVER: 8.8.8.8#53(8.8.8.8)
<a id="__codelineno-6-41" name="__codelineno-6-41"></a>;; WHEN: Sun Feb 19 18:42:07 CET 2023
<a id="__codelineno-6-42" name="__codelineno-6-42"></a>;; MSG SIZE  rcvd: 85
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We will also use <a href="https://mxtoolbox.com/spf.aspx">MXtoolbox</a> to check the record:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-spf_mxtoolbox.png"><img alt="SPF check" src="../assets/zentyal/mail-spf_mxtoolbox.png" title="SPF check"/></a></p>
</li>
<li>
<p>Finally, we will send an email to an external account - GMail in my case - and verify the headers:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-spf_test-email.png"><img alt="SPF sending check" src="../assets/zentyal/mail-spf_test-email.png" title="SPF sending check"/></a></p>
</li>
</ol>
<h3 id="dkim">DKIM<a class="headerlink" href="#dkim" title="Permanent link">¶</a></h3>
<p><a href="https://www.mimecast.com/content/dkim/">DKIM</a> will be the next security implementation we will carry out. The objective of DKIM is that the receiver can verify that the received email is legitimate. The necessary configuration steps have been taken from <a href="https://doc.zentyal.org/en/mail.html#hardening-the-mail-server">here</a>.</p>
<ol>
<li>
<p>We install the necessary packages for the implementation of DKIM:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>update
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>opendkim<span class="w"> </span>opendkim-tools
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We create the directory where the OpenDKIM keys will be stored:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>sudo<span class="w"> </span>mkdir<span class="w"> </span>-vp<span class="w"> </span>/etc/opendkim/keys
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We generate the private key that will be used to sign the emails and set it as <code>mail</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>sudo<span class="w"> </span>opendkim-genkey<span class="w"> </span>-s<span class="w"> </span>mail<span class="w"> </span>-d<span class="w"> </span>icecrown.es<span class="w"> </span>-D<span class="w"> </span>/etc/opendkim/keys
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We set the correct permissions for the files generated by the previous command:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>opendkim:opendkim<span class="w"> </span>/etc/opendkim/
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span>/etc/opendkim/keys/*.private
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We create the <code>/etc/opendkim/TrustedHosts</code> configuration file and set the trusted domain and IP addresses in it:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="m">127</span>.0.0.1
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>localhost
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="m">15</span>.237.168.75/32
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>mail.icecrown.es
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We create the configuration file <code>/etc/opendkim/SigningTable</code> which will contain the domain to be signed by OpenDKIM.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>*@icecrown.es mail._domainkey.icecrown.es
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We create the configuration file <code>/etc/opendkim/KeyTable</code> which will have the selector name and the path to the private key responsible for signing the emails.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>mail._domainkey.icecrown.es icecrown.es:mail:/etc/opendkim/keys/mail.private
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We create the main configuration file named <code>/etc/opendkim.conf</code> and set the configuration of the OpenDKIM service.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>Syslog                  yes
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>LogWhy                  yes
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>UMask                   007
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>Mode                    sv
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>SubDomains              no
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>Canonicalization        relaxed/simple
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>Socket                  inet:8891@127.0.0.1
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>PidFile                 /run/opendkim/opendkim.pid
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>OversignHeaders         From
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>TrustAnchorFile         /usr/share/dns/root.key
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>UserID                  opendkim
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>AutoRestart             yes
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>AutoRestartRate         10/1M
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>Background              yes
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>DNSTimeout              5
<a id="__codelineno-14-16" name="__codelineno-14-16"></a>SignatureAlgorithm      rsa-sha256
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>InternalHosts           refile:/etc/opendkim/TrustedHosts
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>KeyTable                refile:/etc/opendkim/KeyTable
<a id="__codelineno-14-20" name="__codelineno-14-20"></a>Signingtable            refile:/etc/opendkim/SigningTable
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We set the socket configuration in the configuration file <code>/etc/default/opendkim</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>## Custom configuration created on 19-02-2023 by Daniel
<a id="__codelineno-15-2" name="__codelineno-15-2"></a># SOCKET=local:$RUNDIR/opendkim.sock
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>SOCKET=inet:8891@127.0.0.1
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We enable, restart, and verify the OpenDKIM service:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>opendkim
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>opendkim
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>opendkim
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>The content of the <code>TXT</code> record that we need to create in the domain is located in the configuration file <code>/etc/opendkim/keys/mail.txt</code>.</p>
<p>In my case, the content is:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>mail._domainkey IN  TXT ( "v=DKIM1; h=sha256; k=rsa; "
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>  "p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu2kM2TmbrV6DNQR37F3EZ4YSgfRWV+XLI7Fi02pSqNuPeIwKIRBpoHRj7FU2ff4fHN8fg7iO3qkGbH5vwY8RgLM46pYE4pth0Zl7prFy3YJU6Kz4kzA9JKKAypU7+Z5ji+t+5zKGIJ49CQzIm8czRjnCYdI8ZjTBvUOo36lkVEO2qn43vAoL1a4gFJh3ZdSAqBdGMqVqcgINyn"
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>  "9ss6+JNE3kbdsbztcR+IeU+6PJZDGTr7VLJ1dXi3NM8HH+R1phgWXKjIScEX4sM3okzPnXZoKSFpNORLVfHf/LwwWF3VLNEpI2zjGYVjc7/jEqZCqZmk/8VNYkUA7vcMyColzJAwIDAQAB" )  ; ----- DKIM key mail for icecrown.es
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We create the DNS record of type <code>TXT</code> both on the Zentyal server and on the DNS provider.</p>
<p>To create the record on the Zentyal server, we will have to use the CLI due to Zentyal's character limitation in the graphical environment:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span>
<span class="normal"><a href="#__codelineno-18-8">8</a></span>
<span class="normal"><a href="#__codelineno-18-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>sudo<span class="w"> </span>samba-tool<span class="w"> </span>dns<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span>icecrown.es<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span>mail._domainkey.icecrown.es<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span>TXT<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="s1">'v=DKIM1; h=sha256; k=rsa;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="s1">    "p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu2kM2TmbrV6DNQR37F3EZ4YSgfRWV+XLI7Fi02pSqNuPeIwKIRBpoHRj7FU2ff4fHN8fg7iO3qkGbH5vwY8RgLM46pYE4pth0Zl7prFy3YJU6Kz4kzA9JKKAypU7+Z5ji+t+5zKGIJ49CQzIm8czRjnCYdI8ZjTBvUOo36lkVEO2qn43vAoL1a4gFJh3ZdSAqBdGMqVqcgINyn"</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="s1">    "9ss6+JNE3kbdsbztcR+IeU+6PJZDGTr7VLJ1dXi3NM8HH+R1phgWXKjIScEX4sM3okzPnXZoKSFpNORLVfHf/LwwWF3VLNEpI2zjGYVjc7/jEqZCqZmk/8VNYkUA7vcMyColzJAwIDAQAB"'</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span>-U<span class="w"> </span>zenadmin
</code></pre></div></td></tr></table></div>
<p>For Route53:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dkim_route53.png"><img alt='"DNS record for DKIM in Route53"' src="../assets/zentyal/mail-dkim_route53.png" title="DNS record for DKIM in Route53"/></a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>We must pay attention to the quotation marks when creating the TXT record.</p>
</div>
</li>
<li>
<p>We check the resolution of the new record both internally and externally.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a>dig<span class="w"> </span>TXT<span class="w"> </span>mail._domainkey.icecrown.es
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>dig<span class="w"> </span>@8.8.8.8<span class="w"> </span>TXT<span class="w"> </span>mail._domainkey.icecrown.es
</code></pre></div></td></tr></table></div>
<p>The result obtained in my case is:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span>
<span class="normal"><a href="#__codelineno-20-35">35</a></span>
<span class="normal"><a href="#__codelineno-20-36">36</a></span>
<span class="normal"><a href="#__codelineno-20-37">37</a></span>
<span class="normal"><a href="#__codelineno-20-38">38</a></span>
<span class="normal"><a href="#__codelineno-20-39">39</a></span>
<span class="normal"><a href="#__codelineno-20-40">40</a></span>
<span class="normal"><a href="#__codelineno-20-41">41</a></span>
<span class="normal"><a href="#__codelineno-20-42">42</a></span>
<span class="normal"><a href="#__codelineno-20-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a>## Internal query (from Zentyal)
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; TXT mail._domainkey.icecrown.es
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>;; global options: +cmd
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>;; Got answer:
<a id="__codelineno-20-5" name="__codelineno-20-5"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 47343
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>; EDNS: version: 0, flags:; udp: 4096
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>; COOKIE: e524c5bb228993ae0100000063f26951777512932a30cbc1 (good)
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>;; QUESTION SECTION:
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>;mail._domainkey.icecrown.es.   IN  TXT
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a>;; ANSWER SECTION:
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>mail._domainkey.icecrown.es. 900 IN TXT "v=DKIM1;" "h=sha256;" "k=rsa;" "p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu2kM2TmbrV6DNQR37F3EZ4YSgfRWV+XLI7Fi02pSqNuPeIwKIRBpoHRj7FU2ff4fHN8fg7iO3qkGbH5vwY8RgLM46pYE4pth0Zl7prFy3YJU6Kz4kzA9JKKAypU7+Z5ji+t+5zKGIJ49CQzIm8czRjnCYdI8ZjTBvUOo36lkVEO2qn43vAoL1a4gFJh3ZdSAqBdGMqVqcgINyn" "9ss6+JNE3kbdsbztcR+IeU+6PJZDGTr7VLJ1dXi3NM8HH+R1phgWXKjIScEX4sM3okzPnXZoKSFpNORLVfHf/LwwWF3VLNEpI2zjGYVjc7/jEqZCqZmk/8VNYkUA7vcMyColzJAwIDAQAB"
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a>;; Query time: 4 msec
<a id="__codelineno-20-18" name="__codelineno-20-18"></a>;; SERVER: 127.0.0.1#53(127.0.0.1)
<a id="__codelineno-20-19" name="__codelineno-20-19"></a>;; WHEN: Sun Feb 19 19:24:17 CET 2023
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>;; MSG SIZE  rcvd: 518
<a id="__codelineno-20-21" name="__codelineno-20-21"></a>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a>
<a id="__codelineno-20-23" name="__codelineno-20-23"></a>## External query
<a id="__codelineno-20-24" name="__codelineno-20-24"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; @8.8.8.8 TXT mail._domainkey.icecrown.es
<a id="__codelineno-20-25" name="__codelineno-20-25"></a>; (1 server found)
<a id="__codelineno-20-26" name="__codelineno-20-26"></a>;; global options: +cmd
<a id="__codelineno-20-27" name="__codelineno-20-27"></a>;; Got answer:
<a id="__codelineno-20-28" name="__codelineno-20-28"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 58941
<a id="__codelineno-20-29" name="__codelineno-20-29"></a>;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-20-30" name="__codelineno-20-30"></a>
<a id="__codelineno-20-31" name="__codelineno-20-31"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-20-32" name="__codelineno-20-32"></a>; EDNS: version: 0, flags:; udp: 512
<a id="__codelineno-20-33" name="__codelineno-20-33"></a>;; QUESTION SECTION:
<a id="__codelineno-20-34" name="__codelineno-20-34"></a>;mail._domainkey.icecrown.es.   IN  TXT
<a id="__codelineno-20-35" name="__codelineno-20-35"></a>
<a id="__codelineno-20-36" name="__codelineno-20-36"></a>;; ANSWER SECTION:
<a id="__codelineno-20-37" name="__codelineno-20-37"></a>mail._domainkey.icecrown.es. 300 IN TXT "9ss6+JNE3kbdsbztcR+IeU+6PJZDGTr7VLJ1dXi3NM8HH+R1phgWXKjIScEX4sM3okzPnXZoKSFpNORLVfHf/LwwWF3VLNEpI2zjGYVjc7/jEqZCqZmk/8VNYkUA7vcMyColzJAwIDAQAB"
<a id="__codelineno-20-38" name="__codelineno-20-38"></a>mail._domainkey.icecrown.es. 300 IN TXT "v=DKIM1; h=sha256; k=rsa;" "p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu2kM2TmbrV6DNQR37F3EZ4YSgfRWV+XLI7Fi02pSqNuPeIwKIRBpoHRj7FU2ff4fHN8fg7iO3qkGbH5vwY8RgLM46pYE4pth0Zl7prFy3YJU6Kz4kzA9JKKAypU7+Z5ji+t+5zKGIJ49CQzIm8czRjnCYdI8ZjTBvUOo36lkVEO2qn43vAoL1a4gFJh3ZdSAqBdGMqVqcgINyn"
<a id="__codelineno-20-39" name="__codelineno-20-39"></a>
<a id="__codelineno-20-40" name="__codelineno-20-40"></a>;; Query time: 16 msec
<a id="__codelineno-20-41" name="__codelineno-20-41"></a>;; SERVER: 8.8.8.8#53(8.8.8.8)
<a id="__codelineno-20-42" name="__codelineno-20-42"></a>;; WHEN: Sun Feb 19 19:25:24 CET 2023
<a id="__codelineno-20-43" name="__codelineno-20-43"></a>;; MSG SIZE  rcvd: 502
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We will also use <a href="https://mxtoolbox.com/dkim.aspx">MXtoolbox</a> to check the record:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dkim_mxtoolbox.png"><img alt="MXtoolbox" src="../assets/zentyal/mail-dkim_mxtoolbox.png" title="DKIM check"/></a></p>
</li>
<li>
<p>Once the DNS record is confirmed, we will proceed to configure the Postfix (SMTP) service to make use of this service. To do this, we add the following lines at the end of the stub <code>/etc/zentyal/stubs/mail/main.cf.mas</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>## DKIM Configuration created on 19-02-2023 by Daniel
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>milter_protocol = 6
<a id="__codelineno-21-3" name="__codelineno-21-3"></a>milter_default_action = accept
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>smtpd_milters = inet:127.0.0.1:8891
<a id="__codelineno-21-5" name="__codelineno-21-5"></a>non_smtpd_milters = inet:127.0.0.1:8891
</code></pre></div></td></tr></table></div>
<p>If we do not have this file, we will have to execute the following commands:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a>sudo<span class="w"> </span>mkdir<span class="w"> </span>-v<span class="w"> </span>/etc/zentyal/stubs/mail/
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>sudo<span class="w"> </span>cp<span class="w"> </span>-v<span class="w"> </span>/usr/share/zentyal/stubs/mail/main.cf.mas<span class="w"> </span>/etc/zentyal/stubs/mail/main.cf.mas
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We restart the mail module to apply the changes.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a>sudo<span class="w"> </span>zs<span class="w"> </span>mail<span class="w"> </span>restart
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Finally, we will send an email to an external account - GMail in my case - and verify the headers.</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dkim-test-email.png"><img alt="DKIM headers" src="../assets/zentyal/mail-dkim-test-email.png" title="DKIM headers"/></a></p>
</li>
</ol>
<h3 id="dmarc">DMARC<a class="headerlink" href="#dmarc" title="Permanent link">¶</a></h3>
<p>The last implementation we will perform will be <a href="https://www.dmarcanalyzer.com/es/dmarc-3/">DMARC</a>. This authentication mechanism will integrate with SPF and DKIM, so it will be necessary to have them previously implemented.</p>
<ol>
<li>
<p>Through <a href="https://mxtoolbox.com/DMARCRecordGenerator.aspx">this</a> website, we will generate the necessary DNS record to implement this authentication method:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dmarc-generator_1.png"><img alt="DMARC generator 1" src="../assets/zentyal/mail-dmarc-generator_1.png" title="DMARC generator 1"/></a>
<a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dmarc-generator_2.png"><img alt="DMARC generator 2" src="../assets/zentyal/mail-dmarc-generator_2.png" title="DMARC generator 2"/></a></p>
</li>
<li>
<p>We create the DNS record of type <code>TXT</code> on both the Zentyal server and the DNS provider:</p>
<p>For the Zentyal server, we go to <code>DNS -&gt; Domains -&gt; TXT records</code>:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dmarc_zentyal.png"><img alt='"DNS record for DMARC in Zentyal"' src="../assets/zentyal/mail-dmarc_zentyal.png" title="DNS record for DMARC in Zentyal"/></a></p>
<p>For Route53:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dmarc_route53.png"><img alt='"DNS record for DMARC in Route53"' src="../assets/zentyal/mail-dmarc_route53.png" title="DNS record for DMARC in Route53"/></a></p>
</li>
<li>
<p>We check the resolution of the new record both internally and externally:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>dig<span class="w"> </span>TXT<span class="w"> </span>_DMARC.icecrown.es
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>dig<span class="w"> </span>@8.8.8.8<span class="w"> </span>TXT<span class="w"> </span>_DMARC.icecrown.es
</code></pre></div></td></tr></table></div>
<p>The result obtained in my case:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span>
<span class="normal"><a href="#__codelineno-25-30">30</a></span>
<span class="normal"><a href="#__codelineno-25-31">31</a></span>
<span class="normal"><a href="#__codelineno-25-32">32</a></span>
<span class="normal"><a href="#__codelineno-25-33">33</a></span>
<span class="normal"><a href="#__codelineno-25-34">34</a></span>
<span class="normal"><a href="#__codelineno-25-35">35</a></span>
<span class="normal"><a href="#__codelineno-25-36">36</a></span>
<span class="normal"><a href="#__codelineno-25-37">37</a></span>
<span class="normal"><a href="#__codelineno-25-38">38</a></span>
<span class="normal"><a href="#__codelineno-25-39">39</a></span>
<span class="normal"><a href="#__codelineno-25-40">40</a></span>
<span class="normal"><a href="#__codelineno-25-41">41</a></span>
<span class="normal"><a href="#__codelineno-25-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a>## Internal query (from Zentyal)
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; TXT _DMARC.novadevs.com
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>;; global options: +cmd
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>;; Got answer:
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 37988
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>; EDNS: version: 0, flags:; udp: 4096
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>; COOKIE: 035a971807e4de9f0100000063f27c0e87c3ffcc2d62887c (good)
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>;; QUESTION SECTION:
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>;_DMARC.novadevs.com.       IN  TXT
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>;; ANSWER SECTION:
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>_DMARC.novadevs.com.    14400   IN  TXT "v=DMARC1; p=quarantine; sp=quarantine; adkim=s; aspf=s; rua=mailto:webmaster@novadevs.com; ruf=mailto:webmaster@novadevs.com; rf=afrf; pct=100; ri=86400"
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>;; Query time: 40 msec
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>;; SERVER: 127.0.0.1#53(127.0.0.1)
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>;; WHEN: Sun Feb 19 20:44:14 CET 2023
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>;; MSG SIZE  rcvd: 241
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>## External query
<a id="__codelineno-25-24" name="__codelineno-25-24"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; @8.8.8.8 TXT _DMARC.icecrown.es
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>; (1 server found)
<a id="__codelineno-25-26" name="__codelineno-25-26"></a>;; global options: +cmd
<a id="__codelineno-25-27" name="__codelineno-25-27"></a>;; Got answer:
<a id="__codelineno-25-28" name="__codelineno-25-28"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 42645
<a id="__codelineno-25-29" name="__codelineno-25-29"></a>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-25-30" name="__codelineno-25-30"></a>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-25-32" name="__codelineno-25-32"></a>; EDNS: version: 0, flags:; udp: 512
<a id="__codelineno-25-33" name="__codelineno-25-33"></a>;; QUESTION SECTION:
<a id="__codelineno-25-34" name="__codelineno-25-34"></a>;_DMARC.icecrown.es.        IN  TXT
<a id="__codelineno-25-35" name="__codelineno-25-35"></a>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a>;; ANSWER SECTION:
<a id="__codelineno-25-37" name="__codelineno-25-37"></a>_DMARC.icecrown.es. 300 IN  TXT "v=DMARC1; p=quarantine; rua=mailto:issues@icecrown.es; ruf=mailto:issues@icecrown.es; rf=afrf; sp=quarantine; fo=1; pct=100; ri=86400; adkim=s; aspf=s"
<a id="__codelineno-25-38" name="__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a>;; Query time: 16 msec
<a id="__codelineno-25-40" name="__codelineno-25-40"></a>;; SERVER: 8.8.8.8#53(8.8.8.8)
<a id="__codelineno-25-41" name="__codelineno-25-41"></a>;; WHEN: Sun Feb 19 20:44:48 CET 2023
<a id="__codelineno-25-42" name="__codelineno-25-42"></a>;; MSG SIZE  rcvd: 210
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We will also use <a href="https://mxtoolbox.com/DMARC.aspx">MXtoolbox</a> to check the record:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dmarc_mxtoolbox.png"><img alt="DMARC check" src="../assets/zentyal/mail-dmarc_mxtoolbox.png" title="DMARC check"/></a></p>
</li>
<li>
<p>Finally, we will send an email to an external account - Gmail in my case - and verify the headers:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="100%" href="../assets/zentyal/mail-dmarc-test_email.png"><img alt="DMARC sending email" src="../assets/zentyal/mail-dmarc-test_email.png" title="DMARC sending email"/></a></p>
</li>
</ol>
<h2 id="webmail-module">Webmail module<a class="headerlink" href="#webmail-module" title="Permanent link">¶</a></h2>
<p>The Webmail module serves its content through the Apache service, which by default displays too much information, which can be used for a possible attack.</p>
<h3 id="apache">Apache<a class="headerlink" href="#apache" title="Permanent link">¶</a></h3>
<p>By default, it is possible to obtain the version of Ubuntu and Apache used by the web service. Additionally, the default Apache page is very characteristic. Therefore, we will proceed to reduce the information that is possible to obtain by querying the service and also create a very simple page.</p>
<ol>
<li>
<p>We modify the following configuration parameters in the file <code>/etc/apache2/conf-enabled/security.conf</code> to reduce the service information:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span>-e<span class="w"> </span><span class="s1">'s/^ServerSignature.*/ServerSignature Off/'</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span>-e<span class="w"> </span><span class="s1">'s/^ServerTokens.*/ServerTokens Prod/'</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span>/etc/apache2/conf-enabled/security.conf
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>We restart the service to apply the changes:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>apache2
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>Finally, we modify the default index:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">'&lt;h1&gt;Website not found&lt;/h1&gt;'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/var/www/html/index.html
</code></pre></div></td></tr></table></div>
</li>
</ol>
<hr/>
<div class="md-source-file">
<small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 12, 2023</span>
<br/>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 12, 2023</span>
</small>
</div>
</article>
</div>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            Back to top
          </button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.indexes", "toc.integrate", "content.code.copy", "content.code.annotate", "navigation.top"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.51198bba.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>